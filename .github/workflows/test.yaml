name: Run Azure CLI Login with OpenID Connect
on: [push, workflow_dispatch]

# https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure-openid-connect

permissions:
  id-token: write # Require write permission to Fetch an OIDC token.
  contents: read
jobs:
    test:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
          - uses: hashicorp/setup-terraform@v3

          - name: Azure CLI Login
            uses: azure/login@v2
            with:
              client-id: ${{ secrets.AZURE_CLIENT_ID }}
              tenant-id: ${{ secrets.AZURE_TENANT_ID }}
              subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
          - name: Azure CLI script, list resources
            uses: azure/cli@v2
            with:
              azcliversion: latest
              inlineScript: |
                  az account show;
                  az resource list --resource-group hisham-rg
            # You can write your Azure CLI inline scripts here.
          - name: Terraform Init
            run: terraform init
            
          - name: Terraform Plan
            run: terraform plan 
              -var "storage_acc_name=${{ vars.STORAGE_ACCOUNT }}" 
              -var "subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}"
              
          - name: Terraform Apply
            run: terraform apply -auto-approve 
              -var "storage_acc_name=${{ vars.STORAGE_ACCOUNT }}" 
              -var "subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}"
